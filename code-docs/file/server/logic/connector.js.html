<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">server/logic/connector.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/hoist/portal.hoist.io.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/index.js~PortalServer.html">PortalServer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/base_controller.js~BaseController.html">BaseController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://hapijs.com/api#reply-interface">HapiReply</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/application</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/application/application_controller.js~ApplicationController.html">ApplicationController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/connector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/connector/connector_controller.js~ConnectorController.html">ConnectorController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/console</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/console/console_controller.js~ConsoleController.html">ConsoleController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/editor</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/editor/editor_controller.js~EditorController.html">EditorController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/event</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/event/event_controller.js~EventController.html">EventController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/healthcheck</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/healthcheck/healthcheck_controller.js~HealthcheckController.html">HealthcheckController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/organisation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/organisation/organisation_controller.js~OrganisationController.html">OrganisationController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/session</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/session/session_controller.js~SessionController.html">SessionController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/user</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/user/user_controller.js~UserController.html">UserController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">configuration</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/authentication.js~AuthenticationConfigurator.html">AuthenticationConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/base_configurator.js~BaseConfigurator.html">BaseConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/logging.js~LoggingConfigurator.html">LoggingConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/routes.js~RouteConfigurator.html">RouteConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/server.js~ServerConfigurator.html">ServerConfigurator</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">logic</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getApplicationPath">getApplicationPath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAuthUrl">getAuthUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAvailableConnectors">getAvailableConnectors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getConnectorsForApplication">getConnectorsForApplication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUniqueConnectorKey">getUniqueConnectorKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadConnector">loadConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-populateConnector">populateConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setupDefaultConnector">setupDefaultConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMessages">getMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCodeForEvent">getCodeForEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-saveScript">saveScript</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendForgottenPasswordEmail">sendForgottenPasswordEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendNoUserAcountEmail">sendNoUserAcountEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createEvent">createEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createModuleForEvent">createModuleForEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEvents">getEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mapEventToModule">mapEventToModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createSessionForUser">createSessionForUser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureLogin">ensureLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getSessionDetails">getSessionDetails</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-logLogin">logLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateApplication">updateApplication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateOrganisation">updateOrganisation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllSettings">getAllSettings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activateForgottenPassword">activateForgottenPassword</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createForgottenPassword">createForgottenPassword</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/models/connector_view_model.js~ConnectorViewModel.html">ConnectorViewModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-closeConnection">closeConnection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMessages">getMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setupQueue">setupQueue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sanitiseName">sanitiseName</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">server/logic/connector.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {
  ConnectorSetting
} from &apos;@hoist/model&apos;;
import fs from &apos;fs&apos;;
import Bluebird from &apos;bluebird&apos;;
import logger from &apos;@hoist/logger&apos;;
import path from &apos;path&apos;;
import config from &apos;config&apos;;
import url from &apos;url&apos;;
import r from &apos;request&apos;;
Bluebird.promisifyAll(r);
Bluebird.promisifyAll(fs);
const _logger = logger.child({
  cls: &apos;ConnectorLogic&apos;
});
/**
 * returns all connnectors for this application
 * @param {string} applicationId - the id of the application to use
 * @returns {Promise&lt;Array&lt;ConnectorViewModel&gt;&gt;} - the connectors
 */
export function getConnectorsForApplication(applicationId) {
  return Promise
    .resolve(ConnectorSetting.findAsync({
      application: applicationId
    }))
    .then((connectorSettings) =&gt; Promise.all(connectorSettings.map(connectorSetting =&gt; populateConnector(connectorSetting))));
}
/**
 * given a connector setting, returns an object loading up the settings and the events that come from the connector
 * @param {ConnectorSetting} connectorSetting - the connector setting to populate
 * @returns {Promise&lt;ConnectorViewModel&gt;} - the connector view model
 */
export function populateConnector(connectorSetting) {
  let ConnectorViewModel = require(&apos;../models/connector_view_model&apos;)
    .ConnectorViewModel;
  return Promise
    .resolve()
    .then(() =&gt; {
      let model = new ConnectorViewModel(connectorSetting);
      return model
        .populate()
        .then(() =&gt; model);
    })
}
export function loadConnector(applicationId, connectorKey) {
  return ConnectorSetting
    .findOneAsync({
      key: connectorKey,
      application: applicationId
    })
    .then((connectorSetting) =&gt; {
      if (connectorSetting) {
        return populateConnector(connectorSetting);
      }
    })
}
export function getAvailableConnectors() {
  return Promise
    .resolve()
    .then(() =&gt; {
      return fs.readdirAsync(config.get(&apos;Hoist.filePaths.connectors&apos;));
    })
    .then((directoryListing) =&gt; {
      _logger.info(&apos;directory listing retrieved&apos;);
      return Promise.all(directoryListing.map((file) =&gt; {
        return fs.statAsync(path.join(config.get(&apos;Hoist.filePaths.connectors&apos;), file))
          .then((stat) =&gt; {
            return {
              dir: file,
              isDirectory: stat.isDirectory()
            };
          });
      }));
    })
    .then((listingMappings) =&gt; {
      return listingMappings.filter((listing) =&gt; {
        return listing.isDirectory;
      });
    })
    .then((connectors) =&gt; {
      var rootDirectory = path.resolve(config.get(&apos;Hoist.filePaths.connectors&apos;));
      return Promise.all(connectors.map((connector) =&gt; {
        return fs
          .realpathAsync(path.join(rootDirectory, connector.dir, &apos;current&apos;))
          .then((connectorDir) =&gt; {
            let settingsPath = path.join(connectorDir, &apos;connector.json&apos;);
            if (!fs.existsSync(settingsPath)) {
              return null;
            } else {
              return require(settingsPath);
            }
          })
          .then((settings) =&gt; {
            return Object.assign({}, {
              settings
            }, {
              key: connector.dir
            });
          });
      }));
    })
    .catch(function (err) {
      _logger.alert(err);
      _logger.error(err);
      throw err;
      return [];
    });
}
export function setupDefaultConnector(application, connectorType) {

  //find the root connector settings
  return ConnectorSetting.findOneAsync({
      application: config.get(&apos;Hoist.admin.applicationId&apos;),
      key: &apos;hoist-root-&apos; + connectorType
    })
    .then((rootConnectorSetting) =&gt; {
      _logger.info({
        rootConnectorSetting
      }, &apos;root connector loaded&apos;);
      let connectorKey = rootConnectorSetting.defaultKey || connectorType.replace(&apos;hoist-connector-&apos;, &apos;&apos;);
      _logger.info({
        connectorKey
      }, &apos;connector key&apos;);
      return getUniqueConnectorKey(connectorKey, application._id)
        .then((key) =&gt; {
          let {
            name,
            settings,
            connectorType
          } = rootConnectorSetting;
          let newConnectorSettings = {
            application: application,
            name,
            settings,
            key,
            connectorType,
            environment: &apos;live&apos;
          };
          return new ConnectorSetting(newConnectorSettings)
            .saveAsync();
        });
    });
}
export function getUniqueConnectorKey(candidateKey, applicationId, append) {
  let key = candidateKey;
  if (append) {
    key = key + append;
  }
  return ConnectorSetting
    .countAsync({
      application: applicationId,
      key
    })
    .then((count) =&gt; {
      if (count &gt; 0) {
        return getUniqueConnectorKey(candidateKey, applicationId, Math.round(Math.random() * 1000))
      }
      return key;
    });
}
export function getAuthUrl(connector, organisationSlug, applicationSlug, bucketKey = &apos;default&apos;) {
  return Promise.resolve()
    .then(() =&gt; {
      let returnUrl = url.format({
        protocol: config.get(&apos;Hoist.cookies.portal.secure&apos;) ? &apos;https&apos; : &apos;http&apos;,
        host: config.get(&quot;Hoist.domains.portal&quot;),
        pathname: `/${organisationSlug}/${applicationSlug}/connector/${connector.key}`
      });
      let uri = {
        protocol: config.get(&apos;Hoist.cookies.portal.secure&apos;) ? &apos;https&apos; : &apos;http&apos;,
        host: config.get(&quot;Hoist.domains.bouncer&quot;),
        pathname: `/initiate/${organisationSlug}/${applicationSlug}/${connector.key}`,
        query: {
          bucketKey,
          returnUrl
        }
      };
      return r.getAsync(url.format(uri), {
        followRedirect: false
      });
    })
    .then((response) =&gt; {
      if (response.statusCode !== 302) {
        throw new Error(&apos;unexpected response from Bouncer&apos;);
      }
      return response.headers.location;
    });
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
