<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">server/logic/session.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/hoist/portal.hoist.io.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/index.js~PortalServer.html">PortalServer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/base_controller.js~BaseController.html">BaseController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://hapijs.com/api#reply-interface">HapiReply</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/application</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/application/application_controller.js~ApplicationController.html">ApplicationController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/connector</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/connector/connector_controller.js~ConnectorController.html">ConnectorController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/console</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/console/console_controller.js~ConsoleController.html">ConsoleController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/editor</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/editor/editor_controller.js~EditorController.html">EditorController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/event</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/event/event_controller.js~EventController.html">EventController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/healthcheck</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/healthcheck/healthcheck_controller.js~HealthcheckController.html">HealthcheckController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/organisation</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/organisation/organisation_controller.js~OrganisationController.html">OrganisationController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/session</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/session/session_controller.js~SessionController.html">SessionController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">areas/user</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/areas/user/user_controller.js~UserController.html">UserController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">configuration</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/authentication.js~AuthenticationConfigurator.html">AuthenticationConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/base_configurator.js~BaseConfigurator.html">BaseConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/logging.js~LoggingConfigurator.html">LoggingConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/routes.js~RouteConfigurator.html">RouteConfigurator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/configuration/server.js~ServerConfigurator.html">ServerConfigurator</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">logic</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getApplicationPath">getApplicationPath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAuthUrl">getAuthUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAvailableConnectors">getAvailableConnectors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getConnectorsForApplication">getConnectorsForApplication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUniqueConnectorKey">getUniqueConnectorKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadConnector">loadConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-populateConnector">populateConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setupDefaultConnector">setupDefaultConnector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMessages">getMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCodeForEvent">getCodeForEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-saveScript">saveScript</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendForgottenPasswordEmail">sendForgottenPasswordEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendNoUserAcountEmail">sendNoUserAcountEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createEvent">createEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createModuleForEvent">createModuleForEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEvents">getEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mapEventToModule">mapEventToModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createSessionForUser">createSessionForUser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ensureLogin">ensureLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getSessionDetails">getSessionDetails</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-logLogin">logLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateApplication">updateApplication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateOrganisation">updateOrganisation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllSettings">getAllSettings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-activateForgottenPassword">activateForgottenPassword</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createForgottenPassword">createForgottenPassword</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/models/connector_view_model.js~ConnectorViewModel.html">ConnectorViewModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-closeConnection">closeConnection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMessages">getMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setupQueue">setupQueue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sanitiseName">sanitiseName</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">server/logic/session.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {
  IpLog,
  LoginLog,
  Application,
  HoistUser,
  Organisation,
  Session
} from &apos;@hoist/model&apos;;
import errors from &apos;@hoist/errors&apos;;

import logger from &apos;@hoist/logger&apos;;

let _logger = logger.child({cls: &apos;SessionLogic&apos;});

/**
 * get a user based on login details, verifies password and ip address
 * @param {object} credentials - the user credentials
 * @param {string} credentials.email - the user email
 * @param {string} credentials.password - this user password
 * @param {string} credentials.ipAddress - the users ipAddress
 * @returns {Promise&lt;HoistUser&gt;} - the hoist user on successful login
 * @throws {errors.user.request.InvalidError} when the email or password is incorrect
 * @throws {errors.user.credentials.IncorrectError} when the user email or password are incorrect
 * @throws {errors.user.request.IPLockedError} when ip address is locked
 * @throws {errors.user.request.AccountLockedError} when ip address is locked
 */
export function ensureLogin({
  email = &quot;&quot;,
  password,
  ipAddress
}) {
  return Promise
    .resolve()
    .then(() =&gt; {
      _logger.info(&apos;checking ip address&apos;);
      return IpLog.assertIP({ipAddress});
    })
    .then(() =&gt; {
      /* ensure request parameters are ok */
      _logger.info(&apos;checking email and username are set&apos;);
      if (!email || email.length &lt; 1) {
        throw new errors
          .user
          .request
          .InvalidError(&quot;invalid email supplied&quot;);
      }
      if (!password || password.length &lt; 1) {
        throw new errors
          .user
          .request
          .InvalidError(&quot;invalid password supplied&quot;);
      }
    })
    .then(() =&gt; {
      /* load up the user */
      _logger.info(&apos;finding user&apos;);
      return HoistUser.findOneAsync({
        &apos;emailAddresses.address&apos;: email.toLowerCase()
      });
    })
    .then((user) =&gt; {
      if (!user) {
        _logger.info(&apos;email address supplied was incorrect&apos;);
        throw new errors
          .user
          .credentials
          .IncorrectError();
      }
      _logger.info(&apos;checking user lock&apos;);
      /* ensure the user isn&apos;t locked*/
      return LoginLog
        .assertUser(user)
        .then(() =&gt; user);
    })
    .then((user) =&gt; {
      /* check the user password */
      _logger.info(&apos;checking password&apos;);
      if (!user.verifyPassword(password)) {
        _logger.info(&apos;password supplied was incorrect&apos;);
        throw new errors
          .user
          .credentials
          .IncorrectError();
      }
      return user;
    });
}

/**
 * creates a session for the user based on their last logged in session
 * @param {HoistUser} user - the user to create a session for
 * @returns {Promise&lt;Session&gt;} - the created session
 */
export function createSessionForUser(user) {
  /* load up the last session from this user */
  return Session
    .find({user: user._id})
    .sort({updatedAt: -1})
    .limit(1)
    .select({_id: -1, organisation: 1, application: 1})
    .exec()
    .then(([lastSession]) =&gt; {
      let sessionData = Object.assign({}, {
        user: user
      }, lastSession);
      if (!sessionData.organisation &amp;&amp; user.organisations &amp;&amp; user.organisations.length &gt; 0) {
        sessionData.organisation = user.organisations[user.organisations.length - 1];
      }
      if (!sessionData.application &amp;&amp; sessionData.organisation) {
        //load first application for organisation by created date desc
        return Application
          .find({organisation: sessionData.organisation})
          .sort({updatedAt: -1})
          .limit(1)
          .select({_id: 1})
          .exec()
          .then(([application]) =&gt; {
            if (application) {
              sessionData.application = application._id;
            }
            return sessionData;
          });
      }
      return sessionData;
    })
    .then((sessionData) =&gt; new Session(sessionData).saveAsync())
    .then((result) =&gt; {
      if (result &amp;&amp; result.length) {
        return result[0];
      } else {
        return result;
      }
    });
}

/**
 * saves login attempts to the database against username and ip addresses
 * @param {object} credentials - the user credentials
 * @param {string} credentials.email - the user email
 * @param {string} credentials.ipAddress - the users ipAddress
 * @param {bool} success - if the login was successful or not
 * @returns {Promise} - a promise to have saved the login logs
 */
export function logLogin({
  email = &quot;&quot;,
  ipAddress
}, success) {
  return Promise.all([
    new IpLog({ip: ipAddress, success}).saveAsync(),
    new LoginLog({
      username: email.toLowerCase(),
      success
    }).saveAsync()
  ])
}

/**
 * load up details of the users session from a session object
 * @param {Session} session - the users current session
 * @returns {SessionDetails} - the details of the currently logged in session
 */
export function getSessionDetails(session) {
  let user;
  let organisation;
  let application;
  let organisations;
  let applications;
  return Promise
    .resolve()
    .then(() =&gt; {
      return session
        .populate({path: &apos;organisation&apos;, select: &apos;_id slug name isPersonal&apos;})
        .populate({path: &apos;application&apos;, select: &apos;_id slug name apiKey settings&apos;})
        .populate({path: &apos;user&apos;, select: &apos;name organisations emailAddresses role&apos;})
        .execPopulate();
    })
    .then(() =&gt; {
      session = session.toJSON();
      user = Object.assign({}, session.user);
      application = Object.assign({}, session.application);
      organisation = Object.assign({}, session.organisation);
    })
    .then(() =&gt; {
      if (user &amp;&amp; user.organisations) {
        return Organisation.findAsync({
          _id: {
            $in: user.organisations
          }
        }, &apos;slug name isPersonal&apos;).then((result) =&gt; {
          organisations = result.map((org) =&gt; Object.assign({}, org.toJSON()));
          if (!organisation || !organisation._id) {
            if (organisations.length &gt; 0) {
              organisation = organisations[organisations.length - 1];
            }
          }
        });
      }
    })
    .then(() =&gt; {
      if (organisation &amp;&amp; organisation._id) {
        return Application.findAsync({
          organisation: organisation._id
        }, &apos;slug name apiKey settings&apos;).then((results) =&gt; {
          applications = results.map((app) =&gt; Object.assign({}, app.toJSON()));
          if (applications.length &gt; 0) {
            if (!application || !application._id) {
              application = applications[applications.length - 1];
            }
          }
        });
      }
    })
    .then(() =&gt; {
      return {user, organisation, application, organisations, applications}
    });
}

/**
 * updates the session organisation, (sets the session application appropriately too) then returns the new session
 * @param {Session} session - the users current session
 * @param {string} organisationId - the new organisation id
 * @returns {SessionDetails} - the details of the currently logged in session
 * @throws {errors.model.organisation.NotFoundError} - either the organisation doesn&apos;t exist or the user doesn&apos;t have access
 */
export function updateOrganisation(session, organisationId) {
  return Promise
    .resolve()
    .then(() =&gt; {
      if (!session.user.organisations.find((id) =&gt; id === organisationId)) {
        throw new errors
          .model
          .organisation
          .NotFoundError();
      } else {
        session.organisation = organisationId;
        session.application = null;
        return getSessionDetails(session).then((sessionDetails) =&gt; {
          session.application = sessionDetails.application._id;
          return session
            .saveAsync()
            .then(() =&gt; sessionDetails);
        });
      }
    });
}

/**
 * updates the session application then returns the new session
 * @param {Session} session - the users current session
 * @param {string} applicationId - the new application id
 * @returns {SessionDetails} - the details of the currently logged in session
 * @throws {errors.model.organisation.NotFoundError} - either the organisation doesn&apos;t exist or the user doesn&apos;t have access
 */
export function updateApplication(session, applicationId) {
  return Promise
    .resolve()
    .then(() =&gt; {
      return Application.countAsync({organisation: session.organisation._id, _id: applicationId});
    })
    .then((applicationCount) =&gt; {
      if (applicationCount &lt; 1) {
        throw new errors
          .model
          .organisation
          .NotFoundError();
      }
    })
    .then(() =&gt; {
      session.application = applicationId;
      return session
        .saveAsync()
        .then(() =&gt; getSessionDetails(session));
    });
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
